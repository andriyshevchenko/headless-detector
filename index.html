<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Headless Browser Detector - Test Suite</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üïµÔ∏è Headless Browser Detector</h1>
            <p>Real-time detection of automation frameworks and headless browsers</p>
            <a href="behavior-monitor.html" aria-label="Navigate to Behavior Monitor test page" style="display: inline-block; color: white; text-decoration: none; margin-top: 10px; opacity: 0.9; transition: opacity 0.2s;">üß† Try Behavior Monitor ‚Üí</a>
        </div>

        <div id="loading" class="loading">
            <div>üîç Analyzing browser environment...</div>
        </div>

        <div id="results" style="display: none;">
            <!-- Score Card -->
            <div class="score-card">
                <div class="score-label">Headless Detection Score</div>
                <div class="score-value" id="score">0.00</div>
                <div id="status-badge" class="status-badge status-normal">Normal Browser</div>
                <p style="margin-top: 15px; color: #666; font-size: 0.95rem;">
                    Score ranges from 0.0 (normal browser) to 1.0 (definitely headless)
                </p>
            </div>

            <!-- Detection Cards Grid -->
            <div class="grid">
                <!-- WebDriver Detection -->
                <div class="card">
                    <div class="card-title">
                        <span class="card-icon">ü§ñ</span>
                        WebDriver Detection
                    </div>
                    <div class="check-item">
                        <span class="check-label">WebDriver Present</span>
                        <span class="check-value" id="webdriver-status">-</span>
                    </div>
                </div>

                <!-- CDP Artifacts -->
                <div class="card">
                    <div class="card-title">
                        <span class="card-icon">üîß</span>
                        CDP Artifacts
                    </div>
                    <div class="check-item">
                        <span class="check-label">Detected</span>
                        <span class="check-value" id="cdp-detected">-</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">CDC Keys Found</span>
                        <span class="check-value info" id="cdp-keys">-</span>
                    </div>
                    <div id="cdp-signals" class="signal-list" style="display: none;"></div>
                </div>

                <!-- User Agent -->
                <div class="card">
                    <div class="card-title">
                        <span class="card-icon">üì±</span>
                        User Agent
                    </div>
                    <div class="check-item">
                        <span class="check-label">Suspicious Patterns</span>
                        <span class="check-value" id="ua-suspicious">-</span>
                    </div>
                    <div id="ua-matches" class="signal-list" style="display: none;"></div>
                </div>

                <!-- WebGL Renderer -->
                <div class="card">
                    <div class="card-title">
                        <span class="card-icon">üé®</span>
                        WebGL Renderer
                        <span class="new-badge">ENHANCED</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">Supported</span>
                        <span class="check-value" id="webgl-supported">-</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">Software Renderer</span>
                        <span class="check-value" id="webgl-software">-</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">Renderer</span>
                        <span class="check-value info" id="webgl-renderer">-</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">Rendering Test</span>
                        <span class="check-value" id="webgl-rendering-test">-</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">Noise Ratio</span>
                        <span class="check-value info" id="webgl-noise">-</span>
                    </div>
                </div>

                <!-- Worker UA Check (NEW 2026) -->
                <div class="card">
                    <div class="card-title">
                        <span class="card-icon">üîß</span>
                        Worker UA Check
                        <span class="new-badge">NEW 2026</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">Available</span>
                        <span class="check-value" id="worker-available">-</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">UA Mismatch</span>
                        <span class="check-value" id="worker-mismatch">-</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">Status</span>
                        <span class="check-value info" id="worker-status">-</span>
                    </div>
                </div>

                <!-- Emoji Rendering (NEW 2026) -->
                <div class="card">
                    <div class="card-title">
                        <span class="card-icon">üòÄ</span>
                        Emoji OS Check
                        <span class="new-badge">NEW 2026</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">Rendered</span>
                        <span class="check-value" id="emoji-rendered">-</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">Detected OS</span>
                        <span class="check-value info" id="emoji-os">-</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">Suspicious</span>
                        <span class="check-value" id="emoji-suspicious">-</span>
                    </div>
                </div>

                <!-- Window Dimensions -->
                <div class="card">
                    <div class="card-title">
                        <span class="card-icon">üìê</span>
                        Window Dimensions
                    </div>
                    <div class="check-item">
                        <span class="check-label">Has Outer Dimensions</span>
                        <span class="check-value" id="outer-dims">-</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">Inner = Outer</span>
                        <span class="check-value" id="inner-outer">-</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">Dimensions</span>
                        <span class="check-value info" id="dimensions">-</span>
                    </div>
                </div>

                <!-- Browser APIs -->
                <div class="card">
                    <div class="card-title">
                        <span class="card-icon">üîå</span>
                        Browser APIs
                    </div>
                    <div class="check-item">
                        <span class="check-label">Plugins</span>
                        <span class="check-value info" id="plugins-count">-</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">Languages</span>
                        <span class="check-value" id="languages-check">-</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">Media Devices</span>
                        <span class="check-value" id="media-devices">-</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">Notifications</span>
                        <span class="check-value" id="notifications">-</span>
                    </div>
                </div>

                <!-- Automation Flags -->
                <div class="card">
                    <div class="card-title">
                        <span class="card-icon">üö®</span>
                        Automation Flags
                    </div>
                    <div id="automation-flags"></div>
                </div>

                <!-- Advanced Checks -->
                <div class="card">
                    <div class="card-title">
                        <span class="card-icon">üî¨</span>
                        Advanced Checks
                    </div>
                    <div class="check-item">
                        <span class="check-label">CDP Stack Trace</span>
                        <span class="check-value" id="adv-stacktrace">-</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">Chrome Runtime</span>
                        <span class="check-value" id="adv-runtime">-</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">Permissions API</span>
                        <span class="check-value" id="adv-permissions">-</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">Console Debug</span>
                        <span class="check-value" id="adv-console">-</span>
                    </div>
                </div>

                <!-- Media Checks -->
                <div class="card">
                    <div class="card-title">
                        <span class="card-icon">üé•</span>
                        Media & WebRTC
                    </div>
                    <div class="check-item">
                        <span class="check-label">WebRTC Available</span>
                        <span class="check-value" id="media-webrtc">-</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">Media Devices Count</span>
                        <span class="check-value info" id="media-devices-count">-</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">Battery API</span>
                        <span class="check-value" id="media-battery">-</span>
                    </div>
                </div>

                <!-- Fingerprint Checks -->
                <div class="card">
                    <div class="card-title">
                        <span class="card-icon">üñåÔ∏è</span>
                        Fingerprinting
                    </div>
                    <div class="check-item">
                        <span class="check-label">Canvas Available</span>
                        <span class="check-value" id="fp-canvas">-</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">Audio Context</span>
                        <span class="check-value" id="fp-audio">-</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">Fonts Detected</span>
                        <span class="check-value info" id="fp-fonts">-</span>
                    </div>
                </div>

                <!-- System Info -->
                <div class="card">
                    <div class="card-title">
                        <span class="card-icon">üíª</span>
                        System Info
                    </div>
                    <div class="check-item">
                        <span class="check-label">Platform</span>
                        <span class="check-value info" id="platform">-</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">CPU Cores</span>
                        <span class="check-value info" id="cpu-cores">-</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">Device Memory</span>
                        <span class="check-value info" id="device-memory">-</span>
                    </div>
                    <div class="check-item">
                        <span class="check-label">Touch Points</span>
                        <span class="check-value info" id="touch-points">-</span>
                    </div>
                </div>
            </div>

            <!-- Metadata -->
            <div class="metadata">
                <div class="metadata-title">üìã Session Metadata</div>
                <div class="metadata-item">
                    <span class="metadata-label">Timestamp:</span>
                    <span class="metadata-value" id="timestamp">-</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">User Agent:</span>
                    <span class="metadata-value" id="user-agent">-</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Timezone:</span>
                    <span class="metadata-value" id="timezone">-</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Screen Resolution:</span>
                    <span class="metadata-value" id="screen-res">-</span>
                </div>
            </div>

            <button class="refresh-btn" onclick="runDetection()">üîÑ Run Detection Again</button>
            
            <!-- Automation Testing Info -->
            <div class="metadata" style="margin-top: 20px; background: #f0f4ff; border: 2px solid #667eea;">
                <div class="metadata-title" style="color: #667eea;">ü§ñ Automation Testing Access</div>
                <div class="metadata-item">
                    <span class="metadata-label">Global Object:</span>
                    <code class="metadata-value" style="background: #fff; padding: 2px 6px; border-radius: 4px;">window.__headlessDetection</code>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Score Access:</span>
                    <code class="metadata-value" style="background: #fff; padding: 2px 6px; border-radius: 4px;">window.__headlessDetectionScore</code>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">DOM Attribute:</span>
                    <code class="metadata-value" style="background: #fff; padding: 2px 6px; border-radius: 4px;">document.documentElement.getAttribute('data-headless-score')</code>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Individual Checks:</span>
                    <code class="metadata-value" style="background: #fff; padding: 2px 6px; border-radius: 4px;">window.HeadlessDetector.checks.*</code>
                </div>
            </div>
        </div>
    </div>

    <script src="scripts/headless-detector.js"></script>
    <script>
        async function runDetection() {
            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';

            try {
                // Run async detection and attach to window for automation access
                const results = await detectHeadless(true);
                displayResults(results);
                
                // Log for automation testing
                console.log('Detection completed. Access via:');
                console.log('  window.__headlessDetection');
                console.log('  window.__headlessDetectionScore =', window.__headlessDetectionScore);
                console.log('  HTML attribute:', document.documentElement.getAttribute('data-headless-score'));
            } catch (error) {
                console.error('Detection failed:', error);
            }
            
            // Hide loading, show results
            document.getElementById('loading').style.display = 'none';
            document.getElementById('results').style.display = 'block';
            
            // Initialize tooltips
            setTimeout(initializeTooltips, 100);
        }

        function displayResults(results) {
            // Score
            const score = results.isHeadless;
            document.getElementById('score').textContent = score.toFixed(2);
            
            const statusBadge = document.getElementById('status-badge');
            if (score < 0.3) {
                statusBadge.className = 'status-badge status-normal';
                statusBadge.textContent = '‚úÖ Normal Browser';
            } else if (score < 0.6) {
                statusBadge.className = 'status-badge status-suspicious';
                statusBadge.textContent = '‚ö†Ô∏è Suspicious Activity';
            } else {
                statusBadge.className = 'status-badge status-headless';
                statusBadge.textContent = 'üö´ Headless Detected';
            }

            // WebDriver
            setStatus('webdriver-status', results.webdriver);

            // CDP Artifacts
            setStatus('cdp-detected', results.cdpArtifacts.detected);
            document.getElementById('cdp-keys').textContent = results.cdpArtifacts.cdcKeysFound || 0;
            
            if (results.cdpArtifacts.signals && results.cdpArtifacts.signals.length > 0) {
                const cdpSignals = document.getElementById('cdp-signals');
                cdpSignals.innerHTML = results.cdpArtifacts.signals.map(s => 
                    `<span class="signal-item">${s}</span>`
                ).join('');
                cdpSignals.style.display = 'block';
            }

            // User Agent
            setStatus('ua-suspicious', results.userAgentFlags.suspicious);
            
            if (results.userAgentFlags.matches && results.userAgentFlags.matches.length > 0) {
                const uaMatches = document.getElementById('ua-matches');
                uaMatches.innerHTML = results.userAgentFlags.matches.map(m => 
                    `<span class="signal-item">${m}</span>`
                ).join('');
                uaMatches.style.display = 'block';
            }

            // WebGL
            setStatus('webgl-supported', results.webglFlags.supported, true);
            setStatus('webgl-software', results.webglFlags.isSoftwareRenderer);
            document.getElementById('webgl-renderer').textContent = 
                results.webglFlags.renderer ? results.webglFlags.renderer.substring(0, 30) : 'N/A';
            
            // WebGL Rendering Test (NEW 2026)
            if (results.webglFlags.renderingTest) {
                const rt = results.webglFlags.renderingTest;
                setStatus('webgl-rendering-test', rt.suspicious);
                document.getElementById('webgl-noise').textContent = 
                    rt.noiseRatio ? `${(parseFloat(rt.noiseRatio) * 100).toFixed(2)}%` : 'N/A';
            }

            // Worker UA Check (NEW 2026)
            if (results.workerChecks) {
                const wc = results.workerChecks;
                setStatus('worker-available', wc.available, true);
                setStatus('worker-mismatch', wc.userAgentMismatch);
                document.getElementById('worker-status').textContent = wc.reason || wc.status || 'N/A';
            }

            // Emoji Rendering (NEW 2026)
            if (results.fingerprintChecks && results.fingerprintChecks.canvas && results.fingerprintChecks.canvas.emojiCheck) {
                const emoji = results.fingerprintChecks.canvas.emojiCheck;
                setStatus('emoji-rendered', emoji.rendered, true);
                document.getElementById('emoji-os').textContent = emoji.detectedOS || 'Unknown';
                setStatus('emoji-suspicious', emoji.suspicious);
            }

            // Window Dimensions
            const hi = results.headlessIndicators;
            setStatus('outer-dims', hi.hasOuterDimensions, true);
            setStatus('inner-outer', hi.innerEqualsOuter);
            document.getElementById('dimensions').textContent = 
                `${hi.innerWidth}x${hi.innerHeight} / ${hi.outerWidth}x${hi.outerHeight}`;

            // Browser APIs
            document.getElementById('plugins-count').textContent = results.automationFlags.plugins;
            setStatus('languages-check', results.automationFlags.languages, true);
            setStatus('media-devices', hi.hasMediaDevices, true);
            
            const notifPerm = hi.notificationPermission;
            const notifEl = document.getElementById('notifications');
            notifEl.textContent = notifPerm;
            notifEl.className = 'check-value ' + 
                (notifPerm === 'denied' ? 'warning' : 
                 notifPerm === 'granted' ? 'pass' : 'info');

            // Automation Flags
            const autoFlags = document.getElementById('automation-flags');
            const flagsToShow = [
                { key: 'domAutomation', id: 'flag-domautomation' },
                { key: '_selenium', id: 'flag-selenium' },
                { key: '__webdriver_evaluate', id: 'flag-webdriver-evaluate' },
                { key: '_phantom', id: 'flag-phantom' },
                { key: '__nightmare', id: 'flag-nightmare' },
                { key: 'callPhantom', id: 'flag-callphantom' }
            ];
            
            autoFlags.innerHTML = flagsToShow.map(flag => {
                const value = results.automationFlags[flag.key];
                return `
                    <div class="check-item">
                        <span class="check-label">${flag.key}</span>
                        <span class="check-value ${value ? 'fail' : 'pass'}" id="${flag.id}">${value ? 'YES' : 'NO'}</span>
                    </div>
                `;
            }).join('');

            // Playwright Detection (2026: Castle.io method)
            const playwrightFlags = [
                { key: '__playwright__binding__', label: '__playwright__binding__', id: 'playwright-binding' },
                { key: '__pwInitScripts', label: '__pwInitScripts', id: 'playwright-initscripts' },
            ];
            
            let playwrightHtml = playwrightFlags.map(flag => {
                const value = results.automationFlags[flag.key];
                return `
                    <div class="check-item">
                        <span class="check-label">${flag.label}</span>
                        <span class="check-value ${value ? 'fail' : 'pass'}" id="${flag.id}">${value ? 'YES' : 'NO'}</span>
                    </div>
                `;
            }).join('');
            
            // Playwright exposed functions
            const pwFuncs = results.automationFlags.playwrightExposedFunctions;
            if (pwFuncs) {
                playwrightHtml += `
                    <div class="check-item">
                        <span class="check-label">Exposed Functions</span>
                        <span class="check-value ${pwFuncs.detected ? 'fail' : 'pass'}" id="playwright-exposed">${pwFuncs.detected ? `YES (${pwFuncs.count})` : 'NO'}</span>
                    </div>
                `;
                if (pwFuncs.functions && pwFuncs.functions.length > 0) {
                    playwrightHtml += `<div style="font-size: 11px; color: #666; margin-top: 5px;">Functions: ${pwFuncs.functions.join(', ')}</div>`;
                }
            }
            
            autoFlags.innerHTML += `
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                    <strong style="color: #764ba2;">üé≠ Playwright Detection</strong>
                    <span class="new-badge" style="background: #764ba2; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 5px;">2026</span>
                </div>
                ${playwrightHtml}
            `;

            // Advanced Checks
            const adv = results.advancedChecks;
            setStatus('adv-stacktrace', adv.stackTrace?.cdpDetected);
            setStatus('adv-runtime', !adv.chromeRuntime?.missing, true);
            setStatus('adv-permissions', !adv.permissions?.deniedByDefault, true);
            setStatus('adv-console', adv.consoleDebug?.detected);

            // Media Checks
            const media = results.mediaChecks;
            setStatus('media-webrtc', !media.webrtc?.suspicious, true);
            document.getElementById('media-devices-count').textContent = 
                media.mediaDevices?.deviceCount !== undefined ? media.mediaDevices.deviceCount : 'N/A';
            setStatus('media-battery', media.battery?.available, true);

            // Fingerprint Checks
            const fp = results.fingerprintChecks;
            setStatus('fp-canvas', fp.canvas?.available, true);
            setStatus('fp-audio', fp.audioContext?.available, true);
            document.getElementById('fp-fonts').textContent = 
                fp.fonts ? `${fp.fonts.detectedCount}/${fp.fonts.totalTested}` : 'N/A';

            // System Info
            document.getElementById('platform').textContent = hi.platform || 'N/A';
            document.getElementById('cpu-cores').textContent = hi.hardwareConcurrency || 'N/A';
            document.getElementById('device-memory').textContent = 
                hi.deviceMemory ? `${hi.deviceMemory} GB` : 'N/A';
            document.getElementById('touch-points').textContent = hi.maxTouchPoints;

            // Metadata
            document.getElementById('timestamp').textContent = new Date(results.timestamp).toLocaleString();
            document.getElementById('user-agent').textContent = results.userAgent;
            document.getElementById('timezone').textContent = 
                `${hi.timezone} (UTC${hi.timezoneOffset > 0 ? '-' : '+'}${Math.abs(hi.timezoneOffset/60)})`;
            document.getElementById('screen-res').textContent = 
                `${hi.screenWidth}x${hi.screenHeight} @ ${hi.devicePixelRatio}x`;
        }

        function setStatus(elementId, value, invertLogic = false) {
            const el = document.getElementById(elementId);
            if (value === undefined || value === null) {
                el.textContent = 'N/A';
                el.className = 'check-value info';
                return;
            }

            if (typeof value === 'boolean') {
                el.textContent = value ? 'YES' : 'NO';
                
                // Invert logic for things where true is good
                const isGood = invertLogic ? value : !value;
                el.className = 'check-value ' + (isGood ? 'pass' : 'fail');
            } else {
                el.textContent = value;
                el.className = 'check-value info';
            }
        }

        // Initialize tooltips
        function initializeTooltips() {
            const results = window.__headlessDetection;
            if (!results) return;

            // Check item explanations - tooltips for individual check items
            if (results.checkItemExplanations) {
                const checkExplanations = results.checkItemExplanations;
                
                // Add tooltips to all check labels
                document.querySelectorAll('.check-label').forEach(label => {
                    // Try to match with explanation keys
                    Object.keys(checkExplanations).forEach(key => {
                        const parentItem = label.closest('.check-item');
                        const valueElement = parentItem?.querySelector(`#${key}`);
                        
                        if (valueElement) {
                            const exp = checkExplanations[key];
                            const tooltipDiv = document.createElement('div');
                            tooltipDiv.className = 'check-item-tooltip';
                            
                            // Determine if this check passed or failed based on value element
                            const valueText = valueElement.textContent.trim().toUpperCase();
                            const hasPassClass = valueElement.classList.contains('pass');
                            const hasFailClass = valueElement.classList.contains('fail');
                            const hasWarningClass = valueElement.classList.contains('warning');
                            
                            // Determine success: pass class, or YES/NO depends on context
                            const isSuccess = hasPassClass || (!hasFailClass && !hasWarningClass && valueText !== '-');
                            const isFail = hasFailClass || hasWarningClass;
                            
                            let content = `<div class="tooltip-desc">${exp.description}</div>`;
                            
                            // Show only relevant status based on actual result
                            if (isFail && exp.bad) {
                                content += `<div class="tooltip-status tooltip-bad">‚úó ${exp.bad}</div>`;
                            } else if (isSuccess && exp.good) {
                                content += `<div class="tooltip-status tooltip-good">‚úì ${exp.good}</div>`;
                            } else if (exp.info) {
                                content += `<div class="tooltip-status tooltip-info">‚Ñπ ${exp.info}</div>`;
                            }
                            
                            tooltipDiv.innerHTML = content;
                            label.appendChild(tooltipDiv);
                        }
                    });
                });
            }
        }

        // Listen for worker check updates
        window.addEventListener('headlessDetectionUpdated', (event) => {
            const workerChecks = event.detail.workerChecks;
            if (workerChecks) {
                setStatus('worker-available', workerChecks.available, true);
                setStatus('worker-mismatch', workerChecks.userAgentMismatch);
                document.getElementById('worker-status').textContent = workerChecks.reason || 'Completed';
                
                // Update score display if mismatch detected
                if (workerChecks.userAgentMismatch) {
                    const scoreEl = document.getElementById('score');
                    const newScore = window.__headlessDetectionScore;
                    scoreEl.textContent = newScore.toFixed(2);
                    
                    const statusBadge = document.getElementById('status-badge');
                    if (newScore >= 0.6) {
                        statusBadge.className = 'status-badge status-headless';
                        statusBadge.textContent = 'üö´ Headless Detected';
                    } else if (newScore >= 0.3) {
                        statusBadge.className = 'status-badge status-suspicious';
                        statusBadge.textContent = '‚ö†Ô∏è Suspicious Activity';
                    }
                }
            }
        });

        // Run detection on page load
        window.addEventListener('load', runDetection);
    </script>
</body>
</html>
