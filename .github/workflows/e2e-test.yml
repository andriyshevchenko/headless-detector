name: E2E Tests

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'
  workflow_dispatch:

# Prevent cancellation of in-progress runs when new commits are pushed
# Each run gets its own unique group to avoid cancellation
concurrency:
  group: e2e-${{ github.run_id }}-${{ github.run_attempt }}
  cancel-in-progress: false

# Run tests in parallel using matrix strategy
# Each test runs in its own isolated job (~7 min each including setup)
# Total CI time: ~8 min instead of ~40 min sequential

jobs:
  e2e-test:
    runs-on: ubuntu-latest
    timeout-minutes: 12  # 5 min test + 7 min buffer for setup/teardown
    permissions:
      contents: read
    
    strategy:
      fail-fast: false  # Continue other tests if one fails
      matrix:
        test:
          - name: human-like
            grep: "5-minute human-like behavior session"
          - name: smooth-jitter
            grep: "5-minute smooth behavior with timing jitter"
          - name: alternating
            grep: "5-minute alternating burst/smooth"
          - name: robot
            grep: "5-minute robot behavior"
          - name: human-impulsive
            grep: "5-minute human-like \\+ impulsive"
          - name: robot-impulsive
            grep: "5-minute robot \\+ impulsive"
    
    name: E2E - ${{ matrix.test.name }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
      
      - name: Install dependencies
        run: npm install
      
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
      
      - name: Run ${{ matrix.test.name }} test
        run: npx playwright test --grep "${{ matrix.test.grep }}"
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ matrix.test.name }}
          path: playwright-report/
          retention-days: 7
      
      - name: Upload test traces
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-traces-${{ matrix.test.name }}
          path: test-results/
          retention-days: 7

  # Summary job that waits for all tests and reports overall status
  e2e-summary:
    needs: e2e-test
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.e2e-test.result }}" == "success" ]; then
            echo "✅ All E2E tests passed!"
            exit 0
          else
            echo "❌ Some E2E tests failed"
            exit 1
          fi
